<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>7번 세팅 도구 · Setup & Monitor Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
      color: #111827;
      background-color: #f3f4f6;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
    }
    .badge-error {
      border-color: #fecaca;
      background: #fef2f2;
      color: #b91c1c;
    }
    .badge-warn {
      border-color: #fcd34d;
      background: #fffbeb;
      color: #92400e;
    }
    .badge-ok {
      border-color: #bbf7d0;
      background: #ecfdf3;
      color: #166534;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .stat {
      font-size: 0.85rem;
      color: #4b5563;
    }
    .stat strong {
      display: block;
      font-size: 1rem;
      color: #111827;
    }
    .stat span {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.8rem;
      background: #111827;
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.danger {
      background: #b91c1c;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .table-wrap {
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #4b5563;
    }
    td a {
      color: #2563eb;
      text-decoration: none;
    }
    td a:hover {
      text-decoration: underline;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    .help-text {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #4b5563;
      margin-right: 4px;
      margin-top: 2px;
    }
    .input {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 0.8rem;
      min-width: 0;
    }
    .input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #bfdbfe;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag-status {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
    }
    .tag-status-정상 {
      border-color: #4ade80;
      background: #ecfdf3;
      color: #166534;
    }
    .tag-status-경고 {
      border-color: #facc15;
      background: #fffbeb;
      color: #854d0e;
    }
    .tag-status-오류 {
      border-color: #fca5a5;
      background: #fef2f2;
      color: #b91c1c;
    }
    .tag-status-미연결 {
      border-color: #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: white;
      border-radius: 12px;
      padding: 16px;
      max-width: 480px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .modal-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .error-list {
      font-size: 0.8rem;
      color: #4b5563;
      margin: 0;
      padding-left: 16px;
    }
    .error-list li {
      margin-bottom: 4px;
    }
    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
      th, td {
        white-space: normal;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="card">
      <div class="card-header">
        <div>
          <h1>7번 세팅 도구 · Setup &amp; Monitor Center</h1>
          <p class="subtitle">
            각 도구의 플랫폼 세팅 · 자동 테스트 · 자동 수정 상태를 한 화면에서 관리하는 전용 도구입니다.
          </p>
        </div>
        <span class="badge" id="engineStatusBadge">엔진 상태: 대기</span>
      </div>
      <div class="grid-3">
        <div class="stat">
          <strong id="statToolCount">0</strong>
          <span>도구 개수</span>
        </div>
        <div class="stat">
          <strong id="statStatusSummary">정상 0 · 경고 0 · 오류 0</strong>
          <span>도구 상태 요약</span>
        </div>
        <div class="stat">
          <strong id="statComplexErrors">0</strong>
          <span>복잡 오류 개수</span>
        </div>
      </div>
      <div class="row" style="margin-top: 12px;">
        <button id="btnReloadTools">도구 목록 새로 불러오기</button>
        <button id="btnRunAllTests" class="secondary">전체 자동 테스트 실행 (예시)</button>
        <span class="help-text">
          · 도구 목록은 <code>/api/tools.json</code>에서 자동으로 감지합니다.
          · 불러온 목록은 브라우저 저장소(localStorage)에 보관되어, 창을 꺼도 다시 나타납니다.
        </span>
      </div>
      <p class="help-text" id="engineMessage"></p>
    </header>

    <section class="card">
      <div class="card-header">
        <div class="card-title">도구별 세팅 및 상태</div>
      </div>
      <p class="help-text">
        · 이 버전부터는 도구를 “클릭해서 열기만 해도” 플랫폼에서 주는 도구 목록(JSON/API)을 자동으로 받아서 보여주는 구조를 목표로 합니다.<br />
        · 지금은 <code>/api/tools.json</code>에서 목록을 받아오는 형태이며, 나중에 플랫폼의 자동 감지 API로 교체할 수 있습니다.
      </p>
      <div class="flex-between" style="margin-top: 8px;">
        <div class="flex">
          <input id="searchInput" class="input" type="text" placeholder="도구 이름 또는 번호 검색" />
          <button id="btnClearSearch" class="secondary">검색 지우기</button>
        </div>
        <div class="flex">
          <select id="statusFilter" class="input">
            <option value="all">필터: 모든 상태</option>
            <option value="정상">정상만</option>
            <option value="경고">경고만</option>
            <option value="오류">오류만</option>
            <option value="미연결">미연결만</option>
          </select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>도구 이름</th>
              <th>상태</th>
              <th>코드 저장소 주소</th>
              <th>배포 주소</th>
              <th>마지막 테스트</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="toolsTableBody">
            <!-- JS로 채움 -->
          </tbody>
        </table>
      </div>
      <p class="help-text">
        · 각 행의 “상태표시 + 세부 보기” 버튼은, 각 도구 화면에서는 가볍게 상태만 보여 주고,<br />
        복잡한 오류 수집·분석·선택 옵션은 이 7번 도구에서 한 번에 관리하도록 설계되어 있습니다.
      </p>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">도구별 자동 테스트·자동 수정 요약</div>
      </div>
      <p class="help-text">
        여기에는 “자동으로 고칠 수 있는 오류”와 “사용자 선택이 필요한 오류”가 모여서 표시됩니다.
        지금은 예시 카드만 두고, 실제 데이터 연결은 다음 단계에서 추가할 수 있습니다.
      </p>
      <div id="errorsSummary" class="help-text">
        현재 자동 수집된 오류 정보 없음 (예시 단계).
      </div>
    </section>
  </div>

  <!-- 오류 상세 모달 -->
  <div class="modal-backdrop" id="errorModalBackdrop">
    <div class="modal">
      <div class="modal-title" id="modalTitle">오류 상세</div>
      <div class="modal-sub" id="modalSub">도구의 자동 테스트 결과와 개선 옵션입니다.</div>
      <ul class="error-list" id="modalErrorList">
        <!-- JS로 채움 -->
      </ul>
      <div class="modal-footer">
        <button id="btnAutoFix" class="secondary">자동 수정 시도</button>
        <button id="btnShowPatch" class="secondary">패치 코드 보기</button>
        <button id="btnDefer" class="secondary">수동 처리로 넘기기</button>
        <button id="btnCloseModal" class="danger">닫기</button>
      </div>
    </div>
  </div>

  <script>
    // 7번 세팅 도구용 간단 상태 관리
    const STORAGE_KEY = "wic_tools_state_v1";
    let tools = [];
    let lastErrors = {};
    let currentModalTool = null;

    // 상태에 따른 뱃지
    function statusClass(status) {
      switch (status) {
        case "정상": return "tag-status tag-status-정상";
        case "경고": return "tag-status tag-status-경고";
        case "오류": return "tag-status tag-status-오류";
        case "미연결":
        default: return "tag-status tag-status-미연결";
      }
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        return parsed.tools || null;
      } catch (e) {
        return null;
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ tools }));
    }

    async function fetchToolsFromApi() {
      const engineMsg = document.getElementById("engineMessage");
      engineMsg.textContent = "도구 목록을 불러오는 중입니다…";
      document.getElementById("engineStatusBadge").textContent = "엔진 상태: 불러오는 중";
      try {
        const res = await fetch("/api/tools.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        // 예상 JSON 형태:
        // { "tools": [ { "id":1, "name":"1번 ...", "status":"정상", "repoUrl":"...", "deployUrl":"...", "lastTest":"2025-12-07 13:00", "complexErrors":1 }, ... ] }
        if (Array.isArray(data.tools)) {
          tools = data.tools;
          saveToStorage();
          engineMsg.textContent = "플랫폼(/api/tools.json)에서 도구 목록을 자동 감지했습니다.";
          document.getElementById("engineStatusBadge").textContent = "엔진 상태: 정상";
        } else {
          throw new Error("잘못된 JSON 구조");
        }
      } catch (err) {
        // API 실패 시: 저장소에 있으면 그걸 쓰고, 없으면 안내만
        const stored = loadFromStorage();
        if (stored && stored.length > 0) {
          tools = stored;
          engineMsg.textContent = "API에서 목록을 가져오지 못했지만, 브라우저에 저장된 목록을 불러왔습니다.";
          document.getElementById("engineStatusBadge").textContent = "엔진 상태: 경고";
        } else {
          tools = [];
          engineMsg.textContent =
            "도구 목록을 불러오지 못했습니다. /api/tools.json을 플랫폼에서 준비하면 자동 감지가 됩니다.";
          document.getElementById("engineStatusBadge").textContent = "엔진 상태: 오류";
        }
      }
      renderAll();
    }

    function renderAll() {
      renderSummary();
      renderTable();
      renderErrorsSummary();
    }

    function renderSummary() {
      const count = tools.length;
      let ok = 0, warn = 0, err = 0;
      tools.forEach(t => {
        if (t.status === "정상") ok++;
        else if (t.status === "경고") warn++;
        else if (t.status === "오류") err++;
      });
      document.getElementById("statToolCount").textContent = count;
      document.getElementById("statStatusSummary").textContent =
        "정상 " + ok + " · 경고 " + warn + " · 오류 " + err;
      let complexCount = 0;
      Object.values(lastErrors).forEach(list => {
        list.forEach(e => {
          if (e.level === "복잡") complexCount++;
        });
      });
      document.getElementById("statComplexErrors").textContent = complexCount;
    }

    function filteredTools() {
      const search = document.getElementById("searchInput").value.trim();
      const filter = document.getElementById("statusFilter").value;
      return tools.filter(t => {
        let pass = true;
        if (search) {
          pass =
            String(t.id).includes(search) ||
            (t.name && t.name.includes(search));
        }
        if (pass && filter !== "all") {
          pass = t.status === filter;
        }
        return pass;
      });
    }

    function renderTable() {
      const tbody = document.getElementById("toolsTableBody");
      tbody.innerHTML = "";
      const list = filteredTools();
      if (list.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "muted";
        td.textContent = "표시할 도구가 없습니다. /api/tools.json이 준비되면 자동으로 목록이 나타납니다.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      list.forEach(t => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = t.id ?? "-";
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.textContent = t.name || "-";
        tr.appendChild(tdName);

        const tdStatus = document.createElement("td");
        const spanStatus = document.createElement("span");
        spanStatus.className = statusClass(t.status);
        spanStatus.textContent = t.status || "미연결";
        tdStatus.appendChild(spanStatus);
        tr.appendChild(tdStatus);

        const tdRepo = document.createElement("td");
        if (t.repoUrl) {
          const a = document.createElement("a");
          a.href = t.repoUrl;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = t.repoUrl;
          tdRepo.appendChild(a);
        } else {
          tdRepo.className = "muted";
          tdRepo.textContent = "-";
        }
        tr.appendChild(tdRepo);

        const tdDeploy = document.createElement("td");
        if (t.deployUrl) {
          const a2 = document.createElement("a");
          a2.href = t.deployUrl;
          a2.target = "_blank";
          a2.rel = "noopener noreferrer";
          a2.textContent = t.deployUrl;
          tdDeploy.appendChild(a2);
        } else {
          tdDeploy.className = "muted";
          tdDeploy.textContent = "-";
        }
        tr.appendChild(tdDeploy);

        const tdLastTest = document.createElement("td");
        tdLastTest.textContent = t.lastTest || "-";
        tr.appendChild(tdLastTest);

        const tdActions = document.createElement("td");
        const btnTest = document.createElement("button");
        btnTest.className = "secondary";
        btnTest.textContent = "자동 테스트 실행";
        btnTest.addEventListener("click", () => runTestForTool(t.id));
        const btnError = document.createElement("button");
        btnError.className = "secondary";
        btnError.textContent = "상태표시 + 세부 보기";
        btnError.addEventListener("click", () => openErrorModal(t.id));
        tdActions.appendChild(btnTest);
        tdActions.appendChild(btnError);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function renderErrorsSummary() {
      const container = document.getElementById("errorsSummary");
      const entries = Object.entries(lastErrors);
      if (entries.length === 0) {
        container.textContent = "현재 자동 수집된 오류 정보 없음 (예시 단계).";
        return;
      }
      const lines = [];
      entries.forEach(([id, list]) => {
        const tool = tools.find(t => String(t.id) === String(id));
        const name = tool ? tool.name : "알 수 없는 도구";
        list.forEach(e => {
          lines.push(
            (id + "번 · " + name) +
            " · " + e.message +
            " · 레벨: " + e.level +
            (e.autoFix ? " · 자동 수정 가능: 예" : " · 자동 수정 가능: 아니오")
          );
        });
      });
      container.innerHTML = lines.map(l => "• " + l).join("<br />");
    }

    // 테스트 실행 (지금은 예시용: 실제로는 API 호출로 교체)
    function runTestForTool(id) {
      const tool = tools.find(t => String(t.id) === String(id));
      if (!tool) return;
      const now = new Date();
      const ts = now.toLocaleString("ko-KR");
      tool.lastTest = ts;
      // 간단 예시: 상태에 따라 오류 리스트를 만든다.
      if (!lastErrors[tool.id]) lastErrors[tool.id] = [];
      lastErrors[tool.id] = []; // 이전 기록 초기화

      if (tool.status === "정상") {
        // 오류 없음
      } else if (tool.status === "경고") {
        lastErrors[tool.id].push({
          level: "중간",
          message: "작은 경고: 링크 지연 또는 느린 응답",
          autoFix: true
        });
      } else if (tool.status === "오류") {
        lastErrors[tool.id].push({
          level: "중간",
          message: "자동 수정이 가능한 간단 오류 (예: 잘못된 링크 1건)",
          autoFix: true
        });
        lastErrors[tool.id].push({
          level: "복잡",
          message: "구조 변경이 필요한 복잡 오류 (예: 라우팅 구조 충돌)",
          autoFix: false
        });
      }
      saveToStorage();
      renderAll();
      alert("도구 " + id + "번 자동 테스트를 실행했습니다. (현재는 예시 동작입니다.)");
    }

    // 모달 열기
    function openErrorModal(id) {
      currentModalTool = tools.find(t => String(t.id) === String(id));
      const list = lastErrors[id] || [];
      document.getElementById("modalTitle").textContent =
        (id + "번 · " + (currentModalTool ? currentModalTool.name : "알 수 없는 도구"));
      document.getElementById("modalSub").textContent =
        "자동 테스트 결과와, 자동 수정/패치/수동 처리 옵션입니다. (지금은 예시 동작입니다.)";
      const ul = document.getElementById("modalErrorList");
      ul.innerHTML = "";
      if (list.length === 0) {
        const li = document.createElement("li");
        li.textContent = "현재 기록된 오류가 없습니다. 먼저 자동 테스트를 실행해 보세요.";
        ul.appendChild(li);
      } else {
        list.forEach(e => {
          const li = document.createElement("li");
          li.textContent =
            "[" + e.level + "] " + e.message +
            (e.autoFix ? " · 자동 수정 가능" : " · 자동 수정 어려움");
          ul.appendChild(li);
        });
      }
      document.getElementById("errorModalBackdrop").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("errorModalBackdrop").style.display = "none";
      currentModalTool = null;
    }

    // 모달 버튼 예시 동작
    function handleAutoFix() {
      if (!currentModalTool) return;
      alert("도구 " + currentModalTool.id + "번에 대해 '자동 수정 시도'를 수행하는 자리에 해당합니다. (실제 패치는 이후 단계에서 API와 연결).");
    }
    function handleShowPatch() {
      if (!currentModalTool) return;
      alert("도구 " + currentModalTool.id + "번에 대한 패치 코드 미리보기 자리에 해당합니다. (나중에 실제 코드가 여기에 표시될 수 있습니다).");
    }
    function handleDefer() {
      if (!currentModalTool) return;
      alert("도구 " + currentModalTool.id + "번의 이 오류는 '수동 처리로 넘기기'로 표시합니다. 7번 도구에서만 관리되는 기록입니다.");
    }

    // 이벤트 연결
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnReloadTools").addEventListener("click", fetchToolsFromApi);
      document.getElementById("btnRunAllTests").addEventListener("click", () => {
        tools.forEach(t => runTestForTool(t.id));
      });
      document.getElementById("searchInput").addEventListener("input", renderTable);
      document.getElementById("statusFilter").addEventListener("change", renderTable);
      document.getElementById("btnClearSearch").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        renderTable();
      });
      document.getElementById("btnCloseModal").addEventListener("click", closeModal);
      document.getElementById("errorModalBackdrop").addEventListener("click", (e) => {
        if (e.target.id === "errorModalBackdrop") closeModal();
      });
      document.getElementById("btnAutoFix").addEventListener("click", handleAutoFix);
      document.getElementById("btnShowPatch").addEventListener("click", handleShowPatch);
      document.getElementById("btnDefer").addEventListener("click", handleDefer);

      // 처음 열 때: API 시도 → 실패해도 저장소에 있으면 그걸 사용
      fetchToolsFromApi();
    });
  </script>
</body>
</html>
