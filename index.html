<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WIC 세팅 도구 v2 · 카드 블록 버전 (7번 도구)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f7fb;
      color: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    h1, h2, h3 {
      margin: 0 0 8px 0;
      font-weight: 600;
    }

    h1 {
      font-size: 20px;
    }

    h2 {
      font-size: 17px;
    }

    h3 {
      font-size: 15px;
    }

    p {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.5;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background-color: #f9fafb;
      gap: 4px;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }

    .page-subtitle {
      font-size: 12px;
      color: #6b7280;
    }

    .pill-note {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #075985;
      display: inline-block;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
      border: 1px solid #e5e7eb;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-header-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-header-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .small-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    textarea,
    input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      background-color: #f9fafb;
      transition: border-color 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea:focus,
    input:focus {
      border-color: #2563eb;
      background-color: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .input-inline-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .input-inline-row input {
      flex: 1;
    }

    .input-inline-prefix {
      font-size: 12px;
      color: #4b5563;
      white-space: nowrap;
    }

    .muted {
      color: #6b7280;
      font-size: 11px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background-color: #2563eb;
      color: #ffffff;
      transition: background-color 0.12s ease, transform 0.06s ease, box-shadow 0.12s ease;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      white-space: nowrap;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(15, 23, 42, 0.2);
    }

    button.secondary {
      background-color: #f3f4f6;
      color: #111827;
      box-shadow: none;
      border: 1px solid #e5e7eb;
    }

    button.secondary:hover {
      background-color: #e5e7eb;
    }

    button.danger {
      background-color: #f97373;
    }

    button.danger:hover {
      background-color: #ef4444;
    }

    .timestamp {
      font-size: 11px;
      color: #6b7280;
    }

    .timestamp strong {
      font-weight: 600;
      color: #111827;
    }

    .hint-list {
      margin-top: 4px;
      padding-left: 16px;
    }

    .hint-list li {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .tool-cards-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 520px;
      overflow: auto;
      padding-right: 2px;
    }

    .tool-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 9px 10px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tool-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .tool-card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .tool-card-subtitle {
      font-size: 11px;
      color: #6b7280;
    }

    .status-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background-color: #ffffff;
      white-space: nowrap;
    }

    .status-ok {
      border-color: #4ade80;
      background-color: #ecfdf5;
      color: #166534;
    }

    .status-warn {
      border-color: #facc15;
      background-color: #fffbeb;
      color: #92400e;
    }

    .status-error {
      border-color: #f97373;
      background-color: #fef2f2;
      color: #991b1b;
    }

    .status-muted {
      color: #6b7280;
    }

    .tool-card-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 6px;
    }

    @media (min-width: 720px) {
      .tool-card-grid {
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      }
    }

    .url-display {
      font-size: 11px;
      color: #4b5563;
      padding: 4px 6px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px dashed #e5e7eb;
      overflow-wrap: anywhere;
    }

    .url-display a {
      color: #2563eb;
      text-decoration: none;
    }

    .url-display a:hover {
      text-decoration: underline;
    }

    .tool-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tool-actions-left {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .test-message {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: #6b7280;
    }

    .footer-note strong {
      color: #111827;
    }
  </style>
</head>
<body>
  <header class="page-header">
    <div>
      <h1>WIC 세팅 도구 v2 · 카드 블록 방식 (7번 도구)</h1>
      <div class="page-subtitle">
        도구별 카드 블록을 한 번만 잘 만들고, 나머지는 자동으로 복사·재사용되는 구조입니다.
      </div>
    </div>
    <div class="page-subtitle">
      <span class="pill-note">※ 이 화면에 보이는 것만 동작합니다. (저장: 브라우저 localStorage)</span>
    </div>
  </header>

  <main class="layout">
    <!-- 좌측: 도구 목록 & 기본 주소 -->
    <section class="card">
      <div class="card-header">
        <div class="card-header-main">
          <div class="card-header-title">① 도구 목록 & 기본 주소</div>
          <div class="card-header-sub">
            도구 이름과 번호는 여기서 관리하고, 아래 카드 블록은 자동으로 따라갑니다.
          </div>
        </div>
        <span class="badge">Local-only · Safe DOM</span>
      </div>

      <div>
        <div class="small-label">도구 목록 (한 줄당 1개 · “번호 이름” 형식 권장)</div>
        <textarea id="toolLines" placeholder="예시&#10;1번 고객 자동화 안내서&#10;2번 입찰 프로그램&#10;3번 코딩 기초 연습 도구&#10;4번 연구비 박사 엑셀 생성기&#10;5번 보고서 생성기&#10;7번 세팅 도구"></textarea>
        <ul class="hint-list">
          <li>앞에 숫자를 적으면 자동으로 “1, 2, 3...” 번호를 인식합니다. (예: <code>1번 고객 자동화 안내서</code>)</li>
          <li>번호가 없으면 위에서부터 1, 2, 3 순서대로 자동 부여됩니다.</li>
        </ul>
      </div>

      <div style="margin-top:8px;">
        <div class="small-label">기본 주소 (모든 도구에 공통으로 사용)</div>
        <div class="input-inline-row">
          <span class="input-inline-prefix">GitHub 기본 주소</span>
          <input id="githubBase" type="text" placeholder="https://github.com/obk369369-spec" />
        </div>
        <div class="input-inline-row">
          <span class="input-inline-prefix">Deno 기본 주소</span>
          <input id="denoBase" type="text" placeholder="https://dash.deno.com/projects" />
        </div>
        <div class="input-inline-row">
          <span class="input-inline-prefix">업로드 기본 도메인</span>
          <input id="uploadBase" type="text" placeholder="https://{slug}.obk369369-spec.deno.net" />
        </div>
        <p class="muted">
          · GitHub/Deno 기본 주소는 바뀌는 일이 거의 없으므로, 한 번만 설정해 두고 계속 재사용합니다. <br />
          · 업로드 도메인은 슬러그만 바꾸는 패턴이라면, 설명에 규칙만 적어두고 각 카드에서 슬러그를 관리합니다.
        </p>
      </div>

      <div class="button-row">
        <button id="btnBuildCards" type="button">
          카드 생성 / 갱신
        </button>
        <button id="btnRunAllTests" type="button" class="secondary">
          전체 자동 테스트 1회
        </button>
        <button id="btnResetAll" type="button" class="secondary danger">
          데이터 초기화
        </button>
      </div>

      <div class="timestamp" id="saveStatus">
        자동 저장: <strong>저장 기록 없음</strong>
      </div>

      <div style="margin-top:8px;">
        <h3>② 자동 테스트 규칙 (문자열만 검사)</h3>
        <ul class="hint-list">
          <li>네트워크 요청 없이, “문자열 규칙”으로만 검사합니다.</li>
          <li>GitHub / Deno / 업로드 주소가 비어 있거나 <code>http</code>로 시작하지 않으면 경고가 표시됩니다.</li>
          <li>세 주소 모두 <code>http</code>로 시작하면 “OK” 상태가 됩니다.</li>
        </ul>
      </div>
    </section>

    <!-- 우측: 도구 카드 영역 -->
    <section class="card">
      <div class="card-header">
        <div class="card-header-main">
          <div class="card-header-title">③ 도구 카드 (블록 단위)</div>
          <div class="card-header-sub">
            1개의 카드 블록 구조만 잘 만들어두면, 모든 도구가 같은 형태로 재사용됩니다.
          </div>
        </div>
        <span class="badge">Card-based · Block reuse</span>
      </div>

      <p class="muted">
        · 왼쪽에서 “도구 목록 + 기본 주소”를 설정하고, <strong>카드 생성 / 갱신</strong>을 누르면 여기 카드들이 만들어집니다. <br />
        · 각 카드에서 <strong>GitHub 경로 / Deno 슬러그 / 업로드 슬러그</strong>를 적으면, 아래에 전체 URL이 자동으로 표시됩니다.
      </p>

      <div id="toolCards" class="tool-cards-wrapper">
        <!-- 동적으로 카드가 채워집니다. -->
      </div>

      <div class="footer-note">
        <strong>실행 규칙</strong><br />
        · 서버 통신, 백그라운드 타이머 없이, 이 화면에 보이는 입력창·버튼만 동작합니다. <br />
        · 모든 설정은 브라우저 <code>localStorage</code>에 자동 저장되며, 같은 브라우저에서 다시 열면 복원됩니다.
      </div>
    </section>
  </main>

  <script>
    (function () {
      const STORAGE_KEY = "wic_setting_tool_v2_state";

      const state = {
        toolLines: "",
        githubBase: "",
        denoBase: "",
        uploadBase: "",
        tools: {}, // key: id(string) -> { name, githubPath, denoSlug, uploadSlug, status, message }
        lastSaved: null
      };

      const $toolLines = document.getElementById("toolLines");
      const $githubBase = document.getElementById("githubBase");
      const $denoBase = document.getElementById("denoBase");
      const $uploadBase = document.getElementById("uploadBase");
      const $saveStatus = document.getElementById("saveStatus");
      const $toolCards = document.getElementById("toolCards");
      const $btnBuildCards = document.getElementById("btnBuildCards");
      const $btnRunAllTests = document.getElementById("btnRunAllTests");
      const $btnResetAll = document.getElementById("btnResetAll");

      function loadState() {
        try {
          const raw = window.localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            setDefaultInitial();
            return;
          }
          const parsed = JSON.parse(raw);
          if (typeof parsed === "object" && parsed !== null) {
            if (typeof parsed.toolLines === "string") state.toolLines = parsed.toolLines;
            if (typeof parsed.githubBase === "string") state.githubBase = parsed.githubBase;
            if (typeof parsed.denoBase === "string") state.denoBase = parsed.denoBase;
            if (typeof parsed.uploadBase === "string") state.uploadBase = parsed.uploadBase;
            if (parsed.tools && typeof parsed.tools === "object") state.tools = parsed.tools;
            if (parsed.lastSaved) state.lastSaved = parsed.lastSaved;
          } else {
            setDefaultInitial();
          }
        } catch (e) {
          setDefaultInitial();
        }
      }

      function setDefaultInitial() {
        state.toolLines = [
          "1번 고객 자동화 안내서",
          "2번 입찰 프로그램",
          "3번 코딩 기초 연습 도구",
          "4번 연구비 박사 엑셀 생성기",
          "5번 보고서 생성기",
          "7번 세팅 도구"
        ].join("\n");
        state.githubBase = "https://github.com/obk369369-spec";
        state.denoBase = "https://dash.deno.com/projects";
        state.uploadBase = "https://{slug}.obk369369-spec.deno.net";
        state.tools = {};
        state.lastSaved = null;
      }

      function saveState() {
        try {
          state.lastSaved = Date.now();
          const data = JSON.stringify(state);
          window.localStorage.setItem(STORAGE_KEY, data);
          updateSaveStatus();
        } catch (e) {
          // localStorage 실패 시 조용히 무시 (UI만 사용)
        }
      }

      let saveTimer = null;
      function scheduleSave() {
        if (saveTimer) {
          clearTimeout(saveTimer);
        }
        saveTimer = setTimeout(saveState, 400);
      }

      function updateSaveStatus() {
        if (!state.lastSaved) {
          $saveStatus.textContent = "자동 저장: 저장 기록 없음";
          return;
        }
        const d = new Date(state.lastSaved);
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        $saveStatus.innerHTML =
          '자동 저장: <strong>' + hh + "시 " + mm + "분 " + ss + "초</strong>";
      }

      function applyStateToInputs() {
        $toolLines.value = state.toolLines || "";
        $githubBase.value = state.githubBase || "";
        $denoBase.value = state.denoBase || "";
        $uploadBase.value = state.uploadBase || "";
        updateSaveStatus();
      }

      function parseToolLines(text) {
        const lines = (text || "")
          .split("\n")
          .map((l) => l.trim())
          .filter((l) => l.length > 0);

        const result = [];
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          let id = String(i + 1);
          let name = line;

          const m = line.match(/^(\d+)(?:번|\.|)\s*(.*)$/);
          if (m) {
            id = m[1];
            if (m[2] && m[2].length > 0) {
              name = m[2];
            } else {
              name = line;
            }
          }

          result.push({
            id,
            name
          });
        }
        return result;
      }

      function buildToolCards() {
        const descList = parseToolLines(state.toolLines);
        const newTools = {};

        for (const desc of descList) {
          const existing = state.tools[desc.id] || {};
          newTools[desc.id] = {
            name: desc.name,
            githubPath: existing.githubPath || ("tool-" + desc.id),
            denoSlug: existing.denoSlug || "",
            uploadSlug: existing.uploadSlug || "",
            status: existing.status || "미실행",
            message: existing.message || ""
          };
        }
        state.tools = newTools;
        renderToolCards();
        scheduleSave();
      }

      function renderToolCards() {
        while ($toolCards.firstChild) {
          $toolCards.removeChild($toolCards.firstChild);
        }

        const entries = Object.entries(state.tools).sort((a, b) => {
          const aNum = parseInt(a[0], 10);
          const bNum = parseInt(b[0], 10);
          if (isNaN(aNum) || isNaN(bNum)) {
            return a[0].localeCompare(b[0], "ko");
          }
          return aNum - bNum;
        });

        if (entries.length === 0) {
          const empty = document.createElement("p");
          empty.className = "muted";
          empty.textContent =
            "도구 목록이 비어 있습니다. 왼쪽에서 도구 목록을 입력한 후 “카드 생성 / 갱신”을 눌러주세요.";
          $toolCards.appendChild(empty);
          return;
        }

        for (const [id, tool] of entries) {
          const cardEl = document.createElement("article");
          cardEl.className = "tool-card";
          cardEl.dataset.toolId = id;

          const headerEl = document.createElement("div");
          headerEl.className = "tool-card-header";

          const titleBox = document.createElement("div");
          const titleEl = document.createElement("div");
          titleEl.className = "tool-card-title";
          titleEl.textContent = id + "번 · " + (tool.name || "이름 없음");

          const subEl = document.createElement("div");
          subEl.className = "tool-card-subtitle";
          subEl.textContent = "도구 카드 블록 · GitHub / Deno / 업로드 한 번에 관리";

          titleBox.appendChild(titleEl);
          titleBox.appendChild(subEl);

          const statusEl = document.createElement("div");
          statusEl.className = "status-pill status-muted";
          statusEl.textContent = "테스트 미실행";

          if (tool.status === "ok") {
            statusEl.className = "status-pill status-ok";
            statusEl.textContent = "테스트 완료 (OK)";
          } else if (tool.status === "warn") {
            statusEl.className = "status-pill status-warn";
            statusEl.textContent = "테스트 완료 (경고)";
          } else if (tool.status === "error") {
            statusEl.className = "status-pill status-error";
            statusEl.textContent = "테스트 실패";
          }

          headerEl.appendChild(titleBox);
          headerEl.appendChild(statusEl);

          const gridEl = document.createElement("div");
          gridEl.className = "tool-card-grid";

          const leftCol = document.createElement("div");
          const rightCol = document.createElement("div");

          // GitHub 경로
          const ghLabel = document.createElement("div");
          ghLabel.className = "small-label";
          ghLabel.textContent = "GitHub 경로 (프로젝트/폴더)";
          const ghInput = document.createElement("input");
          ghInput.type = "text";
          ghInput.value = tool.githubPath || "";
          ghInput.placeholder = "예: tool-" + id;

          // Deno 슬러그
          const denoLabel = document.createElement("div");
          denoLabel.className = "small-label";
          denoLabel.textContent = "Deno 프로젝트 슬러그";
          const denoInput = document.createElement("input");
          denoInput.type = "text";
          denoInput.value = tool.denoSlug || "";
          denoInput.placeholder = "예: tool-" + id;

          // 업로드 슬러그
          const upLabel = document.createElement("div");
          upLabel.className = "small-label";
          upLabel.textContent = "업로드 슬러그 (도메인 앞부분)";
          const upInput = document.createElement("input");
          upInput.type = "text";
          upInput.value = tool.uploadSlug || "";
          upInput.placeholder = "예: tool-" + id;

          leftCol.appendChild(ghLabel);
          leftCol.appendChild(ghInput);
          leftCol.appendChild(denoLabel);
          leftCol.appendChild(denoInput);
          leftCol.appendChild(upLabel);
          leftCol.appendChild(upInput);

          // URL 표시 영역
          const urlBlockLabel = document.createElement("div");
          urlBlockLabel.className = "small-label";
          urlBlockLabel.textContent = "자동 생성 URL 미리보기";

          const ghUrlDisplay = document.createElement("div");
          ghUrlDisplay.className = "url-display";

          const denoUrlDisplay = document.createElement("div");
          denoUrlDisplay.className = "url-display";

          const upUrlDisplay = document.createElement("div");
          upUrlDisplay.className = "url-display";

          rightCol.appendChild(urlBlockLabel);
          rightCol.appendChild(ghUrlDisplay);
          rightCol.appendChild(denoUrlDisplay);
          rightCol.appendChild(upUrlDisplay);

          gridEl.appendChild(leftCol);
          gridEl.appendChild(rightCol);

          // 하단 액션 영역
          const actions = document.createElement("div");
          actions.className = "tool-actions";

          const actionsLeft = document.createElement("div");
          actionsLeft.className = "tool-actions-left";

          const testBtn = document.createElement("button");
          testBtn.type = "button";
          testBtn.className = "secondary";
          testBtn.textContent = "이 카드만 테스트";

          const clearBtn = document.createElement("button");
          clearBtn.type = "button";
          clearBtn.className = "secondary";
          clearBtn.textContent = "이 카드 값 초기화";

          actionsLeft.appendChild(testBtn);
          actionsLeft.appendChild(clearBtn);

          const testMsg = document.createElement("div");
          testMsg.className = "test-message";
          testMsg.textContent = tool.message || "아직 테스트 기록이 없습니다.";

          actions.appendChild(actionsLeft);
          actions.appendChild(testMsg);

          cardEl.appendChild(headerEl);
          cardEl.appendChild(gridEl);
          cardEl.appendChild(actions);

          $toolCards.appendChild(cardEl);

          // URL 표시 초기화
          updateUrlDisplaysForCard({
            cardEl,
            id,
            tool,
            ghInput,
            denoInput,
            upInput,
            ghUrlDisplay,
            denoUrlDisplay,
            upUrlDisplay
          });

          ghInput.addEventListener("input", function () {
            state.tools[id].githubPath = ghInput.value;
            updateUrlDisplaysForCard({
              cardEl,
              id,
              tool: state.tools[id],
              ghInput,
              denoInput,
              upInput,
              ghUrlDisplay,
              denoUrlDisplay,
              upUrlDisplay
            });
            scheduleSave();
          });

          denoInput.addEventListener("input", function () {
            state.tools[id].denoSlug = denoInput.value;
            updateUrlDisplaysForCard({
              cardEl,
              id,
              tool: state.tools[id],
              ghInput,
              denoInput,
              upInput,
              ghUrlDisplay,
              denoUrlDisplay,
              upUrlDisplay
            });
            scheduleSave();
          });

          upInput.addEventListener("input", function () {
            state.tools[id].uploadSlug = upInput.value;
            updateUrlDisplaysForCard({
              cardEl,
              id,
              tool: state.tools[id],
              ghInput,
              denoInput,
              upInput,
              ghUrlDisplay,
              denoUrlDisplay,
              upUrlDisplay
            });
            scheduleSave();
          });

          testBtn.addEventListener("click", function () {
            runTestForCard(id, cardEl, ghUrlDisplay, denoUrlDisplay, upUrlDisplay, testMsg, statusEl);
            scheduleSave();
          });

          clearBtn.addEventListener("click", function () {
            state.tools[id].githubPath = "tool-" + id;
            state.tools[id].denoSlug = "";
            state.tools[id].uploadSlug = "";
            state.tools[id].status = "미실행";
            state.tools[id].message = "";

            ghInput.value = state.tools[id].githubPath;
            denoInput.value = "";
            upInput.value = "";
            statusEl.className = "status-pill status-muted";
            statusEl.textContent = "테스트 미실행";
            testMsg.textContent = "아직 테스트 기록이 없습니다.";

            updateUrlDisplaysForCard({
              cardEl,
              id,
              tool: state.tools[id],
              ghInput,
              denoInput,
              upInput,
              ghUrlDisplay,
              denoUrlDisplay,
              upUrlDisplay
            });
            scheduleSave();
          });
        }
      }

      function sanitizeBase(base) {
        if (!base) return "";
        return base.trim().replace(/\/+$/, "");
      }

      function buildGithubUrl(toolId, githubPath) {
        const base = sanitizeBase(state.githubBase);
        const path = (githubPath || "").trim().replace(/^\/+/, "");
        if (!base || !path) return "";
        return base + "/" + path;
      }

      function buildDenoUrl(toolId, denoSlug) {
        const base = sanitizeBase(state.denoBase);
        const slug = (denoSlug || "").trim().replace(/^\/+/, "");
        if (!base || !slug) return "";
        return base + "/" + slug;
      }

      function buildUploadUrl(toolId, uploadSlug) {
        const slug = (uploadSlug || "").trim();
        if (!slug) return "";

        const base = (state.uploadBase || "").trim();
        if (!base) {
          return "https://" + slug + ".obk369369-spec.deno.net";
        }

        if (base.includes("{slug}")) {
          return base.replace("{slug}", slug);
        }

        if (base.includes("*")) {
          return base.replace("*", slug);
        }

        if (base.indexOf("https://") === 0 || base.indexOf("http://") === 0) {
          if (base.indexOf("{") === -1 && base.indexOf("*") === -1) {
            if (/\/$/.test(base)) {
              return base + slug;
            }
            return base + "/" + slug;
          }
        }

        return "https://" + slug + ".obk369369-spec.deno.net";
      }

      function updateUrlDisplaysForCard(ctx) {
        const { id, tool, ghInput, denoInput, upInput, ghUrlDisplay, denoUrlDisplay, upUrlDisplay } = ctx;

        const ghUrl = buildGithubUrl(id, ghInput.value);
        const denoUrl = buildDenoUrl(id, denoInput.value);
        const upUrl = buildUploadUrl(id, upInput.value);

        renderUrlDisplay(ghUrlDisplay, ghUrl, "GitHub");
        renderUrlDisplay(denoUrlDisplay, denoUrl, "Deno");
        renderUrlDisplay(upUrlDisplay, upUrl, "업로드");
      }

      function renderUrlDisplay(container, url, label) {
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        if (!url) {
          container.textContent = label + " URL: (미설정)";
          return;
        }
        const strong = document.createElement("span");
        strong.textContent = label + " URL: ";
        container.appendChild(strong);

        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = url;

        container.appendChild(link);
      }

      function classifyUrl(url) {
        if (!url) return "empty";
        const v = url.trim().toLowerCase();
        if (v.length === 0) return "empty";
        if (!v.startsWith("http://") && !v.startsWith("https://")) return "invalid";
        return "ok";
      }

      function runTestForCard(id, cardEl, ghUrlDisplay, denoUrlDisplay, upUrlDisplay, testMsgEl, statusEl) {
        const tool = state.tools[id] || {};
        const ghText = ghUrlDisplay.textContent || "";
        const denoText = denoUrlDisplay.textContent || "";
        const upText = upUrlDisplay.textContent || "";

        const ghUrlMatch = ghText.match(/https?:\/\/\S+/);
        const denoUrlMatch = denoText.match(/https?:\/\/\S+/);
        const upUrlMatch = upText.match(/https?:\/\/\S+/);

        const ghUrl = ghUrlMatch ? ghUrlMatch[0] : "";
        const denoUrl = denoUrlMatch ? denoUrlMatch[0] : "";
        const upUrl = upUrlMatch ? upUrlMatch[0] : "";

        const ghStatus = classifyUrl(ghUrl);
        const denoStatus = classifyUrl(denoUrl);
        const upStatus = classifyUrl(upUrl);

        const statuses = [ghStatus, denoStatus, upStatus];

        if (statuses.every((s) => s === "ok")) {
          tool.status = "ok";
          tool.message = "세 URL 모두 http로 시작하며, 형식상 문제 없습니다. (문자열 기준 OK)";
          statusEl.className = "status-pill status-ok";
          statusEl.textContent = "테스트 완료 (OK)";
        } else if (statuses.some((s) => s === "invalid")) {
          tool.status = "error";
          tool.message =
            "일부 URL이 http로 시작하지 않거나 형식이 잘못되었습니다. (형식 오류 · 문자열 기준)";
          statusEl.className = "status-pill status-error";
          statusEl.textContent = "테스트 실패";
        } else {
          tool.status = "warn";
          tool.message =
            "일부 URL이 비어 있습니다. 필요한 항목만 채우고 사용하는 경우라면, 문자열 기준으로는 사용 가능합니다.";
          statusEl.className = "status-pill status-warn";
          statusEl.textContent = "테스트 완료 (경고)";
        }

        state.tools[id] = tool;
        testMsgEl.textContent = tool.message;
      }

      function runAllTests() {
        const cards = $toolCards.querySelectorAll(".tool-card");
        cards.forEach((cardEl) => {
          const id = cardEl.dataset.toolId;
          const ghDisplay = cardEl.querySelector(".url-display:nth-of-type(1)");
          const denoDisplay = cardEl.querySelector(".url-display:nth-of-type(2)");
          const upDisplay = cardEl.querySelector(".url-display:nth-of-type(3)");
          const msgEl = cardEl.querySelector(".test-message");
          const statusEl = cardEl.querySelector(".status-pill");
          if (!id || !ghDisplay || !denoDisplay || !upDisplay || !msgEl || !statusEl) return;
          runTestForCard(id, cardEl, ghDisplay, denoDisplay, upDisplay, msgEl, statusEl);
        });
        scheduleSave();
      }

      function resetAllData() {
        if (!window.confirm("모든 설정과 도구 카드 데이터를 초기화할까요? (localStorage 삭제)")) {
          return;
        }
        setDefaultInitial();
        applyStateToInputs();
        buildToolCards();
        saveState();
      }

      function bindEvents() {
        $toolLines.addEventListener("input", function () {
          state.toolLines = $toolLines.value;
          scheduleSave();
        });

        $githubBase.addEventListener("input", function () {
          state.githubBase = $githubBase.value;
          scheduleSave();
        });

        $denoBase.addEventListener("input", function () {
          state.denoBase = $denoBase.value;
          scheduleSave();
        });

        $uploadBase.addEventListener("input", function () {
          state.uploadBase = $uploadBase.value;
          scheduleSave();
        });

        $btnBuildCards.addEventListener("click", function () {
          buildToolCards();
        });

        $btnRunAllTests.addEventListener("click", function () {
          runAllTests();
        });

        $btnResetAll.addEventListener("click", function () {
          resetAllData();
        });
      }

      function init() {
        loadState();
        applyStateToInputs();
        bindEvents();
        buildToolCards();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
