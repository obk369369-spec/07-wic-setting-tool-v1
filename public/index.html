<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WIC 세팅 도구 v2 · 카드 블록 방식 (7번 도구)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      color: #222;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
      font-weight: 600;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }
    .app-header {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    .app-header-title {
      font-size: 18px;
      font-weight: 700;
    }
    .app-header-sub {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: 11px;
    }
    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #d0d0d0;
      background: #fafafa;
      color: #555;
    }
    .tag-strong {
      border-color: #0066dd;
      color: #0050aa;
      background: #e7f1ff;
    }

    .summary-bar {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0 14px;
      padding: 8px;
      border-radius: 10px;
      background: #f2f5ff;
      border: 1px solid #d6e0ff;
      font-size: 12px;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .summary-label {
      color: #555;
    }
    .summary-value {
      font-weight: 600;
      font-size: 13px;
    }
    .summary-note {
      grid-column: 1 / -1;
      font-size: 11px;
      color: #777;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .summary-bar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .section {
      border-radius: 10px;
      border: 1px solid #e1e1e6;
      background: #fafafa;
      padding: 10px 12px 12px;
      margin-bottom: 10px;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
    }
    .section-subtitle {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
    }

    textarea, input[type="text"], input[type="url"] {
      width: 100%;
      padding: 6px 7px;
      border-radius: 6px;
      border: 1px solid #d0d0d5;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
    }
    textarea {
      min-height: 80px;
    }
    label {
      display: block;
      font-size: 11px;
      margin-bottom: 6px;
      color: #444;
    }
    .hint {
      font-size: 10px;
      color: #888;
      margin-top: 3px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    button {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d0d0dd;
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button.primary {
      border-color: #0b63ff;
      background: #0b63ff;
      color: white;
    }
    button.secondary {
      border-color: #d0d0dd;
      background: #f5f5f9;
    }
    button.danger {
      border-color: #d93025;
      background: #ffeceb;
      color: #b00020;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .pill-label {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef1ff;
      font-size: 10px;
      color: #4a5bcc;
      margin-left: 4px;
    }

    .cards-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 480px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .card {
      border-radius: 10px;
      border: 1px solid #dde0ea;
      background: #ffffff;
      padding: 8px 10px 10px;
      font-size: 12px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .card-title {
      font-weight: 600;
      font-size: 13px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid transparent;
    }
    .status-pending {
      border-color: #c4c4cf;
      background: #f5f5f7;
      color: #555;
    }
    .status-ok {
      border-color: #137333;
      background: #e6f4ea;
      color: #137333;
    }
    .status-warn {
      border-color: #e3b341;
      background: #fef7e0;
      color: #8a6d1a;
    }
    .status-error {
      border-color: #d93025;
      background: #fce8e6;
      color: #b00020;
    }
    .card-body {
      display: grid;
      grid-template-columns: 1.4fr 1.6fr;
      gap: 8px;
    }
    @media (max-width: 900px) {
      .card-body {
        grid-template-columns: 1fr;
      }
    }
    .card-col {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .url-preview {
      font-size: 11px;
      padding: 6px 7px;
      border-radius: 6px;
      background: #f7f7fb;
      border: 1px dashed #d0d0e0;
      white-space: nowrap;
      overflow-x: auto;
    }
    .url-line {
      margin-bottom: 2px;
    }
    .url-line:last-child {
      margin-bottom: 0;
    }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .card-msg {
      font-size: 10px;
      color: #777;
    }

    .log-area {
      font-size: 11px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .log-line {
      margin-bottom: 2px;
    }
    .log-line:last-child {
      margin-bottom: 0;
    }
    .log-empty {
      color: #9ca3af;
    }

    .state-line {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    .state-strong {
      font-weight: 600;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-header-title">WIC 세팅 도구 v2 · 카드 블록 방식 (7번 도구)</div>
      <div class="app-header-sub">
        도구별 카드 블록을 한 번만 잘 만들고, 나머지는 자동으로 복사·재사용하는 구조입니다.
      </div>
      <div class="tag-row">
        <span class="tag tag-strong">Local-only</span>
        <span class="tag tag-strong">Safe DOM</span>
        <span class="tag">v2.0</span>
        <span class="tag">브라우저 localStorage 저장</span>
        <span class="tag">서버/타이머 없음</span>
        <span class="tag">이 화면에 보이는 것만 동작</span>
      </div>
    </header>

    <section class="summary-bar" aria-label="전체 상태 요약">
      <div class="summary-item">
        <div class="summary-label">도구</div>
        <div class="summary-value" id="summary-total">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">OK</div>
        <div class="summary-value" id="summary-ok">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">주의/미설정</div>
        <div class="summary-value" id="summary-warn">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">오류</div>
        <div class="summary-value" id="summary-error">0</div>
      </div>
      <div class="summary-note">
        마지막 전체 테스트: <span id="summary-last-test">-</span>
      </div>
    </section>

    <div class="layout">
      <!-- 왼쪽: 도구 목록 & 기본 주소 / 테스트 규칙 -->
      <div>
        <section class="section" aria-label="도구 목록 및 기본 주소">
          <div class="section-header">
            <div class="section-title">① 도구 목록 & 기본 주소</div>
            <span class="pill-label">Local-only · Safe DOM</span>
          </div>
          <div class="section-subtitle">
            도구 이름과 번호는 여기서 관리하고, 아래 카드 블록은 자동으로 따라갑니다.
          </div>

          <label for="toolList">
            도구 목록 (한 줄당 1개 · “번호 이름” 형식 권장) · 예: 1번 고객 자동화 안내서
          </label>
          <textarea id="toolList" placeholder="예시:
1번 고객 자동화 안내서
2번 입찰 프로그램
3번 코딩 기초 연습 도구
4번 연구비 박사 엑셀 생성기
5번 보고서 생성기
7번 세팅 도구"></textarea>
          <div class="hint">
            앞에 숫자를 적으면 자동으로 “1, 2, 3...” 번호를 인식합니다. (예: 1번 고객 자동화 안내서)<br />
            번호가 없으면 위에서부터 1, 2, 3 순서대로 자동 부여됩니다.
          </div>

          <label for="githubBase">
            GitHub 기본 주소 · 거의 바뀌지 않으므로 한 번만 설정합니다.
            <div class="hint">예: https://github.com/obk369369-spec</div>
          </label>
          <input type="url" id="githubBase" placeholder="https://github.com/obk369369-spec" />

          <label for="denoBase">
            Deno 기본 주소 · 대시보드 상단 프로젝트 기본 URL
            <div class="hint">예: https://dash.deno.com/projects</div>
          </label>
          <input type="url" id="denoBase" placeholder="https://dash.deno.com/projects" />

          <label for="uploadPattern">
            업로드 기본 도메인 패턴 · {slug} 위치에 업로드 슬러그가 들어갑니다.
            <div class="hint">예: https://{slug}.obk369369-spec.deno.net</div>
          </label>
          <input type="text" id="uploadPattern" placeholder="https://{slug}.obk369369-spec.deno.net" />

          <div class="btn-row">
            <button id="btnBuildCards" class="primary">카드 생성 / 갱신</button>
            <button id="btnRunAllTests" class="secondary">전체 자동 테스트 1회</button>
            <button id="btnResetAll" class="danger">데이터 초기화</button>
          </div>
          <div class="state-line">
            자동 저장: <span id="autoSaveTime">-</span>
          </div>
        </section>

        <section class="section" aria-label="자동 테스트 규칙">
          <div class="section-header">
            <div class="section-title">② 자동 테스트 규칙 (문자열만 검사)</div>
          </div>
          <div class="section-subtitle">
            네트워크 요청 없이, 문자열 규칙으로만 검사합니다.
          </div>
          <ul style="margin: 0 0 4px 16px; padding: 0; font-size: 11px; color: #555;">
            <li>GitHub / Deno / 업로드 주소가 비어 있거나 <code>http</code>로 시작하지 않으면 주의/오류 상태가 표시됩니다.</li>
            <li>세 주소 모두 <code>http</code>로 시작하면 <strong>OK</strong> 상태가 됩니다.</li>
            <li>현재 버전은 “문자열 규칙 테스트”에만 집중하며, 실제 배포/빌드는 각 도구에서 수행합니다.</li>
          </ul>
        </section>
      </div>

      <!-- 오른쪽: 도구 카드 & 로그 -->
      <div>
        <section class="section" aria-label="도구 카드">
          <div class="section-header">
            <div class="section-title">③ 도구 카드 (블록 단위)</div>
          </div>
          <div class="section-subtitle">
            1개의 카드 블록 구조만 잘 만들고, 모든 도구에 재사용합니다.
          </div>
          <div class="hint" style="margin-bottom: 6px;">
            왼쪽에서 “도구 목록 + 기본 주소”를 설정하고, [카드 생성 / 갱신]을 누르면 아래에 카드들이 만들어집니다.
            각 카드에서 GitHub 경로 / Deno 슬러그 / 업로드 슬러그를 적으면 전체 URL이 자동으로 표시되고,
            테스트 버튼으로 문자열 규칙 검사를 할 수 있습니다.
          </div>

          <div id="cardsContainer" class="cards-container" aria-label="도구 카드 목록">
            <!-- 카드가 여기 동적으로 생성됩니다. -->
          </div>
        </section>

        <section class="section" aria-label="로그 및 상태">
          <div class="section-header">
            <div class="section-title">④ 로그 · 상태</div>
          </div>
          <div class="section-subtitle">
            버튼 클릭·테스트 결과 등이 여기에 누적됩니다.
          </div>
          <div class="btn-row">
            <button id="btnSnapshot" class="secondary">현재 상태 스냅샷 기록</button>
            <button id="btnClearLog" class="danger">로그 초기화</button>
          </div>
          <div class="log-area" id="logArea">
            <div class="log-line log-empty">[로그] 아직 기록이 없습니다.</div>
          </div>
          <div class="state-line">
            실행 규칙: 서버 통신, 백그라운드 타이머 없이, 이 화면에 보이는 입력창·버튼만 동작합니다.
          </div>
          <div class="state-line">
            모든 설정은 이 브라우저의 localStorage에 자동 저장되며, 같은 브라우저에서 다시 열면 복원됩니다.
          </div>
          <div class="state-line">
            이 도구는 각 도구의 GitHub/Deno/업로드 문자열 상태를 “가볍게 테스트”하는 용도로만 사용됩니다.
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "wic_setting_tool_v2_state";

      const elToolList = document.getElementById("toolList");
      const elGithubBase = document.getElementById("githubBase");
      const elDenoBase = document.getElementById("denoBase");
      const elUploadPattern = document.getElementById("uploadPattern");
      const elCardsContainer = document.getElementById("cardsContainer");

      const elSummaryTotal = document.getElementById("summary-total");
      const elSummaryOk = document.getElementById("summary-ok");
      const elSummaryWarn = document.getElementById("summary-warn");
      const elSummaryError = document.getElementById("summary-error");
      const elSummaryLastTest = document.getElementById("summary-last-test");
      const elAutoSaveTime = document.getElementById("autoSaveTime");

      const elBtnBuildCards = document.getElementById("btnBuildCards");
      const elBtnRunAllTests = document.getElementById("btnRunAllTests");
      const elBtnResetAll = document.getElementById("btnResetAll");
      const elBtnSnapshot = document.getElementById("btnSnapshot");
      const elBtnClearLog = document.getElementById("btnClearLog");
      const elLogArea = document.getElementById("logArea");

      let state = {
        toolListText: "",
        githubBase: "",
        denoBase: "",
        uploadPattern: "",
        tools: [], // {id, number, name, githubPath, denoSlug, uploadSlug, status, message}
        summary: {
          total: 0,
          ok: 0,
          warn: 0,
          error: 0,
          lastTestedAt: "-"
        },
        logs: []
      };

      let saveTimer = null;

      function nowTimeString() {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return hh + ":" + mm + ":" + ss;
      }

      function addLog(message) {
        const t = nowTimeString();
        state.logs.push("[" + t + "] " + message);
        if (state.logs.length > 200) {
          state.logs = state.logs.slice(-200);
        }
        renderLogs();
        scheduleSave();
      }

      function renderLogs() {
        elLogArea.innerHTML = "";
        if (!state.logs.length) {
          const empty = document.createElement("div");
          empty.className = "log-line log-empty";
          empty.textContent = "[로그] 아직 기록이 없습니다.";
          elLogArea.appendChild(empty);
          return;
        }
        state.logs.forEach(line => {
          const div = document.createElement("div");
          div.className = "log-line";
          div.textContent = line;
          elLogArea.appendChild(div);
        });
        elLogArea.scrollTop = elLogArea.scrollHeight;
      }

      function saveState() {
        try {
          const data = JSON.stringify(state);
          localStorage.setItem(STORAGE_KEY, data);
          elAutoSaveTime.textContent = nowTimeString();
        } catch (e) {
          // localStorage 실패 시에도 화면만 동작
        }
      }

      function scheduleSave() {
        if (saveTimer) {
          clearTimeout(saveTimer);
        }
        saveTimer = setTimeout(saveState, 300);
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            state = Object.assign(state, parsed);
          }
        } catch (e) {
          // 무시
        }
      }

      function parseToolList(text) {
        const lines = (text || "").split(/\r?\n/);
        const tools = [];
        let autoNum = 1;
        for (let line of lines) {
          const trimmed = line.trim();
          if (!trimmed) continue;
          let number = null;
          let name = trimmed;

          const m = trimmed.match(/^(\d+)\s*번?/);
          if (m) {
            number = parseInt(m[1], 10);
            name = trimmed.replace(/^(\d+)\s*번?/, "").trim();
          } else {
            number = autoNum;
          }
          if (!name) {
            name = number + "번 도구";
          }
          tools.push({
            id: String(number),
            number,
            name
          });
          autoNum++;
        }
        return tools;
      }

      function findToolStateById(id) {
        return state.tools.find(t => t.id === id) || null;
      }

      function ensureToolsExistFromList(parsedList) {
        const newList = [];
        parsedList.forEach(info => {
          const existing = findToolStateById(String(info.number));
          if (existing) {
            // 이름/번호 업데이트
            existing.number = info.number;
            existing.name = info.name;
            newList.push(existing);
          } else {
            newList.push({
              id: String(info.number),
              number: info.number,
              name: info.name,
              githubPath: "tool-" + info.number,
              denoSlug: "",
              uploadSlug: "",
              status: "pending", // pending|ok|warn|error
              message: "아직 테스트 기록이 없습니다."
            });
          }
        });
        state.tools = newList;
      }

      function buildCardElement(tool) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.toolId = tool.id;

        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = tool.number + "번 · " + tool.name;

        const badge = document.createElement("span");
        badge.className = "badge";
        updateBadgeClass(badge, tool.status);
        badge.textContent = statusToLabel(tool.status);

        header.appendChild(title);
        header.appendChild(badge);

        const body = document.createElement("div");
        body.className = "card-body";

        const colLeft = document.createElement("div");
        colLeft.className = "card-col";

        const labelGit = document.createElement("label");
        labelGit.textContent = "GitHub 경로 (프로젝트/폴더)";
        const inputGit = document.createElement("input");
        inputGit.type = "text";
        inputGit.value = tool.githubPath || "";
        inputGit.placeholder = "tool-" + tool.number;
        inputGit.addEventListener("input", () => {
          tool.githubPath = inputGit.value.trim();
          updateUrlsPreview(card, tool);
          scheduleSave();
        });
        labelGit.appendChild(inputGit);
        colLeft.appendChild(labelGit);

        const labelDeno = document.createElement("label");
        labelDeno.textContent = "Deno 프로젝트 슬러그";
        const inputDeno = document.createElement("input");
        inputDeno.type = "text";
        inputDeno.value = tool.denoSlug || "";
        inputDeno.placeholder = "예: tool-" + tool.number;
        inputDeno.addEventListener("input", () => {
          tool.denoSlug = inputDeno.value.trim();
          updateUrlsPreview(card, tool);
          scheduleSave();
        });
        labelDeno.appendChild(inputDeno);
        colLeft.appendChild(labelDeno);

        const labelUpload = document.createElement("label");
        labelUpload.textContent = "업로드 슬러그 (도메인 앞부분)";
        const inputUpload = document.createElement("input");
        inputUpload.type = "text";
        inputUpload.value = tool.uploadSlug || "";
        inputUpload.placeholder = "예: tool-" + tool.number;
        inputUpload.addEventListener("input", () => {
          tool.uploadSlug = inputUpload.value.trim();
          updateUrlsPreview(card, tool);
          scheduleSave();
        });
        labelUpload.appendChild(inputUpload);
        colLeft.appendChild(labelUpload);

        const colRight = document.createElement("div");
        colRight.className = "card-col";

        const previewBox = document.createElement("div");
        previewBox.className = "url-preview";
        previewBox.innerHTML = [
          '<div class="url-line"><strong>자동 생성 URL 미리보기</strong></div>',
          '<div class="url-line" data-url-github>GitHub URL: (미설정)</div>',
          '<div class="url-line" data-url-deno>Deno URL: (미설정)</div>',
          '<div class="url-line" data-url-upload>업로드 URL: (미설정)</div>'
        ].join("");
        colRight.appendChild(previewBox);

        const cardFooter = document.createElement("div");
        cardFooter.className = "card-footer";

        const btnRow = document.createElement("div");
        btnRow.className = "btn-row";

        const btnTest = document.createElement("button");
        btnTest.className = "secondary";
        btnTest.textContent = "이 카드만 테스트";
        btnTest.addEventListener("click", () => {
          runTestForTool(tool, card);
        });

        const btnReset = document.createElement("button");
        btnReset.className = "danger";
        btnReset.textContent = "이 카드 값 초기화";
        btnReset.addEventListener("click", () => {
          inputGit.value = "";
          inputDeno.value = "";
          inputUpload.value = "";
          tool.githubPath = "";
          tool.denoSlug = "";
          tool.uploadSlug = "";
          tool.status = "pending";
          tool.message = "아직 테스트 기록이 없습니다.";
          updateBadgeClass(badge, tool.status);
          badge.textContent = statusToLabel(tool.status);
          updateUrlsPreview(card, tool);
          addLog(tool.number + "번 도구 카드 값 초기화");
          recalcSummary();
          scheduleSave();
        });

        btnRow.appendChild(btnTest);
        btnRow.appendChild(btnReset);

        const msg = document.createElement("div");
        msg.className = "card-msg";
        msg.textContent = tool.message || "아직 테스트 기록이 없습니다.";

        cardFooter.appendChild(btnRow);
        cardFooter.appendChild(msg);

        body.appendChild(colLeft);
        body.appendChild(colRight);

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(cardFooter);

        // 최초 URL 프리뷰 업데이트
        updateUrlsPreview(card, tool);

        // 이후 업데이트를 위해 참조 보관
        card._statusBadge = badge;
        card._statusMsg = msg;

        return card;
      }

      function updateUrlsPreview(card, tool) {
        const githubBase = (elGithubBase.value || "").trim();
        const denoBase = (elDenoBase.value || "").trim();
        const pattern = (elUploadPattern.value || "").trim();

        const ghLine = card.querySelector("[data-url-github]");
        const deLine = card.querySelector("[data-url-deno]");
        const upLine = card.querySelector("[data-url-upload]");

        let ghUrl = "(미설정)";
        if (githubBase && tool.githubPath) {
          ghUrl = githubBase.replace(/\/+$/, "") + "/" + tool.githubPath.replace(/^\/+/, "");
        }
        ghLine.textContent = "GitHub URL: " + ghUrl;

        let deUrl = "(미설정)";
        if (denoBase && tool.denoSlug) {
          deUrl = denoBase.replace(/\/+$/, "") + "/" + tool.denoSlug.replace(/^\/+/, "");
        }
        deLine.textContent = "Deno URL: " + deUrl;

        let upUrl = "(미설정)";
        if (pattern && tool.uploadSlug) {
          if (pattern.includes("{slug}")) {
            upUrl = pattern.replace("{slug}", tool.uploadSlug);
          } else {
            const base = pattern.replace(/\/+$/, "");
            upUrl = base + "/" + tool.uploadSlug;
          }
        }
        upLine.textContent = "업로드 URL: " + upUrl;
      }

      function statusToLabel(status) {
        switch (status) {
          case "ok": return "OK";
          case "warn": return "주의/미설정";
          case "error": return "오류";
          default: return "테스트 미실행";
        }
      }

      function updateBadgeClass(badge, status) {
        badge.className = "badge";
        if (status === "ok") {
          badge.classList.add("status-ok");
        } else if (status === "warn") {
          badge.classList.add("status-warn");
        } else if (status === "error") {
          badge.classList.add("status-error");
        } else {
          badge.classList.add("status-pending");
        }
      }

      function classifyUrls(urls) {
        // urls = [githubUrl, denoUrl, uploadUrl]
        const hasEmpty = urls.some(u => !u);
        const hasInvalid = urls.some(u => u && !u.startsWith("http"));
        if (hasInvalid) return "error";
        if (hasEmpty) return "warn";
        return "ok";
      }

      function runTestForTool(tool, card) {
        const githubBase = (elGithubBase.value || "").trim();
        const denoBase = (elDenoBase.value || "").trim();
        const pattern = (elUploadPattern.value || "").trim();

        let ghUrl = "";
        let deUrl = "";
        let upUrl = "";

        if (githubBase && tool.githubPath) {
          ghUrl = githubBase.replace(/\/+$/, "") + "/" + tool.githubPath.replace(/^\/+/, "");
        }
        if (denoBase && tool.denoSlug) {
          deUrl = denoBase.replace(/\/+$/, "") + "/" + tool.denoSlug.replace(/^\/+/, "");
        }
        if (pattern && tool.uploadSlug) {
          if (pattern.includes("{slug}")) {
            upUrl = pattern.replace("{slug}", tool.uploadSlug);
          } else {
            const base = pattern.replace(/\/+$/, "");
            upUrl = base + "/" + tool.uploadSlug;
          }
        }

        const status = classifyUrls([ghUrl, deUrl, upUrl]);
        tool.status = status;

        let msg;
        if (status === "ok") {
          msg = "세 주소가 모두 http로 시작합니다. (문자열 규칙 OK)";
        } else if (status === "warn") {
          msg = "일부 주소가 비어 있습니다. 값을 채운 뒤 다시 테스트해 주세요.";
        } else if (status === "error") {
          msg = "일부 주소가 http로 시작하지 않습니다. 기본 주소/슬러그를 확인해 주세요.";
        } else {
          msg = "아직 테스트 기록이 없습니다.";
        }
        tool.message = msg;

        if (card._statusBadge) {
          updateBadgeClass(card._statusBadge, status);
          card._statusBadge.textContent = statusToLabel(status);
        }
        if (card._statusMsg) {
          card._statusMsg.textContent = msg;
        }

        addLog(tool.number + "번 도구 테스트 결과: " + statusToLabel(status));
        recalcSummary();
        scheduleSave();
      }

      function recalcSummary() {
        let total = state.tools.length;
        let ok = 0;
        let warn = 0;
        let error = 0;
        state.tools.forEach(t => {
          if (t.status === "ok") ok++;
          else if (t.status === "warn") warn++;
          else if (t.status === "error") error++;
        });
        state.summary.total = total;
        state.summary.ok = ok;
        state.summary.warn = warn;
        state.summary.error = error;

        elSummaryTotal.textContent = total ? String(total) : "-";
        elSummaryOk.textContent = String(ok);
        elSummaryWarn.textContent = String(warn);
        elSummaryError.textContent = String(error);
      }

      function renderSummaryLastTest() {
        elSummaryLastTest.textContent = state.summary.lastTestedAt || "-";
      }

      function renderCards() {
        elCardsContainer.innerHTML = "";
        if (!state.tools.length) {
          const empty = document.createElement("div");
          empty.style.fontSize = "11px";
          empty.style.color = "#777";
          empty.textContent = "도구 목록을 입력한 뒤 [카드 생성 / 갱신]을 눌러 카드들을 생성합니다.";
          elCardsContainer.appendChild(empty);
          return;
        }
        state.tools.forEach(tool => {
          const card = buildCardElement(tool);
          // 상태 배지/메시지 반영
          if (card._statusBadge) {
            updateBadgeClass(card._statusBadge, tool.status || "pending");
            card._statusBadge.textContent = statusToLabel(tool.status || "pending");
          }
          if (card._statusMsg) {
            card._statusMsg.textContent = tool.message || "아직 테스트 기록이 없습니다.";
          }
          elCardsContainer.appendChild(card);
        });
      }

      function syncInputsFromState() {
        elToolList.value = state.toolListText || "";
        elGithubBase.value = state.githubBase || "";
        elDenoBase.value = state.denoBase || "";
        elUploadPattern.value = state.uploadPattern || "";
        recalcSummary();
        renderSummaryLastTest();
        renderCards();
        renderLogs();
      }

      function handleBuildCards() {
        const listText = elToolList.value || "";
        const parsed = parseToolList(listText);
        ensureToolsExistFromList(parsed);
        state.toolListText = listText;
        state.githubBase = (elGithubBase.value || "").trim();
        state.denoBase = (elDenoBase.value || "").trim();
        state.uploadPattern = (elUploadPattern.value || "").trim();
        renderCards();
        recalcSummary();
        addLog("도구 목록 기준으로 카드 생성/갱신 완료 (도구 " + state.tools.length + "개)");
        scheduleSave();
      }

      function handleRunAllTests() {
        if (!state.tools.length) {
          addLog("전체 테스트 실행: 대상 도구가 없습니다.");
          return;
        }
        const cards = elCardsContainer.querySelectorAll(".card");
        const cardMap = {};
        cards.forEach(c => {
          cardMap[c.dataset.toolId] = c;
        });
        state.tools.forEach(tool => {
          const card = cardMap[tool.id];
          if (card) {
            runTestForTool(tool, card);
          }
        });
        state.summary.lastTestedAt = nowTimeString();
        renderSummaryLastTest();
        addLog("전체 자동 테스트 1회 완료");
        scheduleSave();
      }

      function handleResetAll() {
        if (!confirm("모든 설정과 로그를 localStorage에서 초기화할까요?")) {
          return;
        }
        state = {
          toolListText: "",
          githubBase: "",
          denoBase: "",
          uploadPattern: "",
          tools: [],
          summary: {
            total: 0,
            ok: 0,
            warn: 0,
            error: 0,
            lastTestedAt: "-"
          },
          logs: []
        };
        localStorage.removeItem(STORAGE_KEY);
        syncInputsFromState();
        elAutoSaveTime.textContent = "-";
        addLog("데이터 전체 초기화 완료");
      }

      function handleSnapshot() {
        const s = state.summary;
        const msg = "스냅샷 — 도구: " + (s.total || 0) +
          ", OK: " + (s.ok || 0) +
          ", 주의/미설정: " + (s.warn || 0) +
          ", 오류: " + (s.error || 0);
        addLog(msg);
      }

      function handleClearLog() {
        state.logs = [];
        renderLogs();
        scheduleSave();
      }

      function attachInputListeners() {
        elToolList.addEventListener("input", () => {
          state.toolListText = elToolList.value;
          scheduleSave();
        });
        elGithubBase.addEventListener("input", () => {
          state.githubBase = elGithubBase.value.trim();
          // URL 프리뷰 갱신
          const cards = elCardsContainer.querySelectorAll(".card");
          const map = {};
          state.tools.forEach(t => { map[t.id] = t; });
          cards.forEach(card => {
            const t = map[card.dataset.toolId];
            if (t) updateUrlsPreview(card, t);
          });
          scheduleSave();
        });
        elDenoBase.addEventListener("input", () => {
          state.denoBase = elDenoBase.value.trim();
          const cards = elCardsContainer.querySelectorAll(".card");
          const map = {};
          state.tools.forEach(t => { map[t.id] = t; });
          cards.forEach(card => {
            const t = map[card.dataset.toolId];
            if (t) updateUrlsPreview(card, t);
          });
          scheduleSave();
        });
        elUploadPattern.addEventListener("input", () => {
          state.uploadPattern = elUploadPattern.value.trim();
          const cards = elCardsContainer.querySelectorAll(".card");
          const map = {};
          state.tools.forEach(t => { map[t.id] = t; });
          cards.forEach(card => {
            const t = map[card.dataset.toolId];
            if (t) updateUrlsPreview(card, t);
          });
          scheduleSave();
        });
      }

      function init() {
        loadState();
        syncInputsFromState();
        attachInputListeners();

        elBtnBuildCards.addEventListener("click", handleBuildCards);
        elBtnRunAllTests.addEventListener("click", handleRunAllTests);
        elBtnResetAll.addEventListener("click", handleResetAll);
        elBtnSnapshot.addEventListener("click", handleSnapshot);
        elBtnClearLog.addEventListener("click", handleClearLog);

        if (!state.logs.length) {
          addLog("WIC 세팅 도구 v2가 준비되었습니다.");
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
